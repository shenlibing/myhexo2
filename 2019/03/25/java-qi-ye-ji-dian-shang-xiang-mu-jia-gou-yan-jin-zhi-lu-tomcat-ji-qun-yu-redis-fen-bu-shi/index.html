<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Tomcat集群与Redis分布式, 小兵兵">
    <meta name="description" content="Lombok原理及使用下载官网
插件下载
IDEA安装Lombok插件Add the Lombok IntelliJ plugin to add lombok support for IntelliJ:Go to File &amp;gt; Set">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tomcat集群与Redis分布式 | 小兵兵</title>
    <link rel="icon" type="image/png" href="/乌龟.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
        code[class*="language-"], pre[class*="language-"] {
            white-space: pre !important;
        }
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/乌龟.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">小兵兵</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/乌龟.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">小兵兵</div>
        <div class="logo-desc">
            
            言宜慢，心宜善
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/shenlibing/" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/shenlibing/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>


<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = 'edcf6e023b09eaa321449dc8813cdfc9f40ceddd699fe44ebeeb3004375bf2ce';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/21.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Tomcat集群与Redis分布式
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Tomcat/" target="_blank">
                                <span class="chip bg-color">Tomcat</span>
                            </a>
                        
                            <a href="/tags/Redis/" target="_blank">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                            <a href="/tags/Maven/" target="_blank">
                                <span class="chip bg-color">Maven</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/集群/" class="post-category" target="_blank">
                                集群
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-03-25
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        12k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        62 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Lombok原理及使用"><a href="#Lombok原理及使用" class="headerlink" title="Lombok原理及使用"></a>Lombok原理及使用</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="https://projectlombok.org/" target="_blank" rel="noopener">官网</a></p>
<p><a href="https://plugins.jetbrains.com/files/6317/53293/lombok-plugin-0.23-2018.3.zip?updateId=53293&pluginId=6317&family=intellij" target="_blank" rel="noopener">插件下载</a></p>
<h3 id="IDEA安装Lombok插件"><a href="#IDEA安装Lombok插件" class="headerlink" title="IDEA安装Lombok插件"></a>IDEA安装Lombok插件</h3><p>Add the <strong>Lombok IntelliJ plugin</strong> to add lombok support for IntelliJ:<br>Go to <strong>File</strong> &gt; <strong>Settings</strong> &gt; <strong>Plugins</strong><br>Click on <strong>Browse repositories</strong>…<br>Search for <strong>Lombok Plugin</strong><br>Click on <strong>Install plugin</strong><br>Restart IntelliJ IDEA</p>
<h3 id="Maven引入Lombok"><a href="#Maven引入Lombok" class="headerlink" title="Maven引入Lombok"></a>Maven引入Lombok</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.18.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="Java-Decompiler"><a href="#Java-Decompiler" class="headerlink" title="Java Decompiler"></a>Java Decompiler</h3><p><a href="http://java-decompiler.github.io/" target="_blank" rel="noopener">官网</a></p>
<p><a href="https://github-production-release-asset-2e65be.s3.amazonaws.com/32844456/ce9b5e00-42a0-11e9-9001-1d805c82cb1e?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20190325%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20190325T025102Z&X-Amz-Expires=300&X-Amz-Signature=6b28f4eb01b049712bf9b7fc4d2ebf7dc0c55f83ceb82e1159994c7c9f8c37a3&X-Amz-SignedHeaders=host&actor_id=26431704&response-content-disposition=attachment%3B%20filename%3Djd-gui-windows-1.4.1.zip&response-content-type=application%2Foctet-stream" target="_blank" rel="noopener">下载</a></p>
<h3 id="Lombok验证"><a href="#Lombok验证" class="headerlink" title="Lombok验证"></a>Lombok验证</h3><p>通过Java Decompiler验证class文件</p>
<h3 id="Lombok原理"><a href="#Lombok原理" class="headerlink" title="Lombok原理"></a>Lombok原理</h3><p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Lombok%E5%8E%9F%E7%90%86.png" alt></p>
<h2 id="Maven环境隔离"><a href="#Maven环境隔离" class="headerlink" title="Maven环境隔离"></a>Maven环境隔离</h2><h3 id="项目环境"><a href="#项目环境" class="headerlink" title="项目环境"></a>项目环境</h3><p>本地开发环境(Local)</p>
<p>开发环境(Dev)</p>
<p>测试环境(Beta)</p>
<p>线上环境(Prod)</p>
<h3 id="目录初始化"><a href="#目录初始化" class="headerlink" title="目录初始化"></a>目录初始化</h3><p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Maven%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%E7%9B%AE%E5%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt></p>
<h3 id="配置pom-xml"><a href="#配置pom-xml" class="headerlink" title="配置pom.xml"></a>配置pom.xml</h3><p><code>build</code>节点中的<code>resources</code>中增加<code>resource</code>节点</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>src/main/resources.${deploy.type}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>*.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>src/main/resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>project</code>节点中增加<code>profiles</code>节点</p>
<pre class=" language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activation</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activeByDefault</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activeByDefault</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activation</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>deploy.type</span><span class="token punctuation">></span></span>dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>deploy.type</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>beta<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>deploy.type</span><span class="token punctuation">></span></span>beta<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>deploy.type</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>prod<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>deploy.type</span><span class="token punctuation">></span></span>prod<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>deploy.type</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="IDEA中设置默认环境"><a href="#IDEA中设置默认环境" class="headerlink" title="IDEA中设置默认环境"></a>IDEA中设置默认环境</h3><p>在IDEA右侧<code>Maven Projects</code>,选中本地开发环境对应的的环境，点击右下角出现<code>import changes</code>进行更新</p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Maven%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BBIDEA%E4%B8%AD%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%8E%AF%E5%A2%83.png" alt></p>
<p>这里设置的默认环境作用于IDEA中配置的Tomcat启动时发布部署的<code>war</code>包</p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Maven%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BBIDEA%E4%B8%AD%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E7%8E%AF%E5%A2%832.png" alt></p>
<h3 id="编译打包命令"><a href="#编译打包命令" class="headerlink" title="编译打包命令"></a>编译打包命令</h3><h4 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h4><p>手动打<code>war</code>包</p>
<pre><code>mvn clean package -Dmaven.test.skip=true -Pdev
</code></pre><h4 id="线上环境"><a href="#线上环境" class="headerlink" title="线上环境"></a>线上环境</h4><pre><code>mvn clean package -Dmaven.test.skip=true -Pprod
</code></pre><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Maven%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%E9%AA%8C%E8%AF%812.png" alt></p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Maven%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%E9%AA%8C%E8%AF%81.png" alt></p>
<h2 id="Tomcat集群搭建"><a href="#Tomcat集群搭建" class="headerlink" title="Tomcat集群搭建"></a>Tomcat集群搭建</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>通过Nginx负载均衡进行请求转发</p>
<h3 id="单机部署多应用"><a href="#单机部署多应用" class="headerlink" title="单机部署多应用"></a>单机部署多应用</h3><p>单机部署多个Tomcat，第一个Tomcat不变,修改第二个Tomcat</p>
<h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><p>修改/etc/profile增加Tomcat环境变量</p>
<pre><code>#tomcat
export CATALINA_BASE=/opt/module/tomcat1
export CATALINA_HOME=/opt/module/tomcat1
export TOMCAT_HOME=/opt/module/tomcat1

export CATALINA_BASE_2=/opt/module/tomcat2
export CATALINA_HOME_2=/opt/module/tomcat2
export TOMCAT_HOME_2=/opt/module/tomcat2
#export PATH=$PATH:$CATALINA_HOME/bin
</code></pre><p><code>source /etc/profile</code>使配置文件立即生效</p>
<h4 id="编辑catalina-sh"><a href="#编辑catalina-sh" class="headerlink" title="编辑catalina.sh"></a>编辑<code>catalina.sh</code></h4><p>进入<code>/opt/module/tomcat2/bin</code>目录,编辑<code>catalina.sh</code></p>
<pre><code># OS specific support.  $var _must_ be set to either true or false.
export CATALINA_BASE=$CATALINA_BASE_2
export CATALINA_HOME=$CATALINA_HOME_2
</code></pre><h4 id="编辑server-xml"><a href="#编辑server-xml" class="headerlink" title="编辑server.xml"></a>编辑<code>server.xml</code></h4><p>进入<code>/opt/module/tomcat2/conf</code>目录，编辑<code>server.xml</code>，修改3个端口，为了方便，每个端口号加上1000</p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E4%BF%AE%E6%94%B9server.xml.png" alt><br><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E4%BF%AE%E6%94%B9server.xml2.png" alt><br><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E4%BF%AE%E6%94%B9server.xml3.png" alt></p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>启动<code>Tomcat2</code></p>
<pre><code>[root@192 bin]# pwd
/opt/module/tomcat2/bin
[root@192 bin]# ./startup.sh 
Using CATALINA_BASE:   /opt/module/tomcat2
Using CATALINA_HOME:   /opt/module/tomcat2
Using CATALINA_TMPDIR: /opt/module/tomcat2/temp
Using JRE_HOME:        /usr/java/jdk1.7.0_80
Using CLASSPATH:       /opt/module/tomcat2/bin/bootstrap.jar:/opt/module/tomcat2/bin/tomcat-juli.jar
Tomcat started.
</code></pre><p>启动<code>Tomcat1</code></p>
<pre><code>[root@192 bin]# pwd
/opt/module/tomcat1/bin
[root@192 bin]# ./startup.sh 
Using CATALINA_BASE:   /opt/module/tomcat1
Using CATALINA_HOME:   /opt/module/tomcat1
Using CATALINA_TMPDIR: /opt/module/tomcat1/temp
Using JRE_HOME:        /usr/java/jdk1.7.0_80
Using CLASSPATH:       /opt/module/tomcat1/bin/bootstrap.jar:/opt/module/tomcat1/bin/tomcat-juli.jar
Tomcat started.
</code></pre><h3 id="多机部署多应用"><a href="#多机部署多应用" class="headerlink" title="多机部署多应用"></a>多机部署多应用</h3><p>多个服务器并且每个服务器只安装一个<code>Tomcat</code>，要保证它们之间的网络是互通的，方可集群，<code>Nginx</code>在任意一台服务器上即可，也可单独把<code>Nginx</code>服务独立出来一台。</p>
<h2 id="Nginx负载均衡实现"><a href="#Nginx负载均衡实现" class="headerlink" title="Nginx负载均衡实现"></a>Nginx负载均衡实现</h2><h3 id="负载均衡常用策略"><a href="#负载均衡常用策略" class="headerlink" title="负载均衡常用策略"></a>负载均衡常用策略</h3><h4 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h4><p>默认<br>优点：实现简单<br>缺点：不考虑每台服务器处理能力</p>
<h4 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h4><p>优点：<br>考虑了每台服务器处理能力的不同，<code>weight</code>默认是1</p>
<h4 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip hash"></a>ip hash</h4><p>优点：<br>能实现同一个用户访问同一个服务器,可以不改变现有技术架构，直接实现横向拓展<br>缺点：<br>导致服务器请求(负载)不平均(完全依赖<code>ip hash</code>的结果)<br>在<code>ip</code>变化的环境下无法服务</p>
<h4 id="url-hash-第三方"><a href="#url-hash-第三方" class="headerlink" title="url hash(第三方)"></a>url hash(第三方)</h4><p>优点：<br>能实现同一个服务器访问同一个服务器<br>缺点：<br>根据<code>url hash</code>分配请求会不平均，请求频繁的url会请求到同一个服务器上的</p>
<h4 id="fair-第三方"><a href="#fair-第三方" class="headerlink" title="fair(第三方)"></a>fair(第三方)</h4><p>缺点：<br>按后端服务器的响应时间来分配请求，响应时间短的优先分配</p>
<h3 id="负载均衡策略权重配置"><a href="#负载均衡策略权重配置" class="headerlink" title="负载均衡策略权重配置"></a>负载均衡策略权重配置</h3><p>编辑<code>/usr/local/nginx/conf/nginx.conf</code>文件，追加</p>
<pre><code> ###########################vhost##############################################
    include vhost/*.conf;
</code></pre><p>在<code>/usr/local/nginx/conf</code>目录下，新建<code>vhost</code>文件夹</p>
<p>在<code>/usr/local/nginx/conf/vhost</code>目录下，编辑<code>www.mytest.com.conf</code>配置文件</p>
<pre><code>[root@192 sbin]# cat ../conf/vhost/www.mytest.com.conf

upstream 127.0.0.1{
    server 127.0.0.1:8080 weight=1;
    server 127.0.0.1:9080 weight=2;

}
#Start www.mytest.com
server {
    listen 80;
    server_name  www.mytest.com;
    access_log  /usr/local/nginx/logs/access.log combined;
    index  index.html index.htm index.php;


    # send request back to apach
    location / {
         proxy_pass http://127.0.0.1; 
   }
}

</code></pre><h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>替换<code>/opt/module/tomcat2/webapps/ROOT</code>目录下<code>tomcat.png</code></p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E9%AA%8C%E8%AF%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E6%9D%83%E9%87%8D.png" alt></p>
<p>访问<code>www.mytest.com</code>,请求分流一下打到<code>Tomcat1</code>，一下打到<code>Tomcat2</code>，<code>Nginx</code>负载均衡策略权重<code>Tomcat2</code>配置<strong><code>weight=2</code></strong>，Tomcat1配置<strong><code>weight=1</code></strong>，所以访问到<code>Tomcat2</code>的概率是<code>Tomcat1</code>的2倍</p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E9%AA%8C%E8%AF%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E6%9D%83%E9%87%8D2.png" alt></p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E9%AA%8C%E8%AF%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E6%9D%83%E9%87%8D3.png" alt></p>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><h4 id="Session登录信息存储及读取的问题"><a href="#Session登录信息存储及读取的问题" class="headerlink" title="Session登录信息存储及读取的问题"></a><code>Session</code>登录信息存储及读取的问题</h4><h5 id="轮询-1"><a href="#轮询-1" class="headerlink" title="轮询"></a>轮询</h5><p>登录的时候登录了A服务器，session信息存储到A服务器上了<br>Nginx负载均衡策略使用<strong>轮询</strong>或者<strong>最小连接</strong>会导致，第一次访问A服务器，第二次可能访问到B服务器，这个时候存储在A服务器上的session信息在B服务器上读取不到。</p>
<h5 id="ip-hash-1"><a href="#ip-hash-1" class="headerlink" title="ip hash"></a>ip hash</h5><p>Nginx负载均衡策略使用<strong><code>ip hash</code></strong>，那么登录信息还可以从A服务器上访问，但是这个有可能造成某些服务器压力过大，某些服务器又没有什么压力，这个时候压力过大的机器(包括网卡带宽)有可能成为瓶颈，并且请求不够分散。</p>
<h4 id="服务器定时任务并发的问题"><a href="#服务器定时任务并发的问题" class="headerlink" title="服务器定时任务并发的问题"></a>服务器定时任务并发的问题</h4><p>假设有定时关单的<code>Job</code>，单个<code>Tomcat</code>没有任何问题，但是在集群环境下，<code>Spring Schedule</code>定时执行的时候，会都一起执行，会导致数据错乱和资源浪费</p>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>高性能的<code>key-value</code>数据库</p>
<p>内存数据库，支持数据持久化</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><a href="http://download.redis.io/releases/" target="_blank" rel="noopener">linux下载redis-2.8.0.tar.gz</a><br><a href="https://github.com/MicrosoftArchive/redis/releases" target="_blank" rel="noopener">windows</a></p>
<p>解压</p>
<pre><code>[root@192 soft]# tar -zxvf redis-2.8.0.tar.gz -C /opt/module/
</code></pre><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><h5 id="直接启动"><a href="#直接启动" class="headerlink" title="直接启动"></a>直接启动</h5><p>默认是6379端口</p>
<pre><code>[root@192 src]# pwd
/opt/module/redis-2.8.0/src
[root@192 src]# ./redis-server 
[6448] 26 Mar 18:30:37.044 # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf
[6448] 26 Mar 18:30:37.045 * Max number of open files set to 10032
                _._                                                  
           _.-``__ &#39;&#39;-._                                             
      _.-``    `.  `_.  &#39;&#39;-._           Redis 2.8.0 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._                                   
 (    &#39;      ,       .-`  | `,    )     Running in stand alone mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 6379
 |    `-._   `._    /     _.-&#39;    |     PID: 6448
  `-._    `-._  `-./  _.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io        
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |                                  
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
      `-._    `-.__.-&#39;    _.-&#39;                                       
          `-._        _.-&#39;                                           
              `-.__.-&#39;                                               

[6448] 26 Mar 18:30:37.046 # Server started, Redis version 2.8.0

</code></pre><h5 id="指定端口启动"><a href="#指定端口启动" class="headerlink" title="指定端口启动"></a>指定端口启动</h5><pre><code>[root@192 src]# ./redis-server --port 6380
[6457] 26 Mar 18:32:55.317 * Max number of open files set to 10032
                _._                                                  
           _.-``__ &#39;&#39;-._                                             
      _.-``    `.  `_.  &#39;&#39;-._           Redis 2.8.0 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._                                   
 (    &#39;      ,       .-`  | `,    )     Running in stand alone mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 6380
 |    `-._   `._    /     _.-&#39;    |     PID: 6457
  `-._    `-._  `-./  _.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io        
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |                                  
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
      `-._    `-.__.-&#39;    _.-&#39;                                       
          `-._        _.-&#39;                                           
              `-.__.-&#39;                                               

[6457] 26 Mar 18:32:55.318 # Server started, Redis version 2.8.0
</code></pre><h5 id="指定配置文件配置启动"><a href="#指定配置文件配置启动" class="headerlink" title="指定配置文件配置启动"></a>指定配置文件配置启动</h5><p>配置文件修改端口,登录密码</p>
<pre><code>[root@192 redis-2.8.0]# pwd
/opt/module/redis-2.8.0
[root@192 redis-2.8.0]# vim redis.conf 
</code></pre><p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Redis%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%AF%E5%8A%A8.png" alt></p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Redis%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%AF%E5%8A%A82.png" alt></p>
<pre><code>[root@192 src]# ./redis-server ../redis.conf 
[6468] 26 Mar 18:37:12.957 * Max number of open files set to 10032
                _._                                                  
           _.-``__ &#39;&#39;-._                                             
      _.-``    `.  `_.  &#39;&#39;-._           Redis 2.8.0 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._                                   
 (    &#39;      ,       .-`  | `,    )     Running in stand alone mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 6380
 |    `-._   `._    /     _.-&#39;    |     PID: 6468
  `-._    `-._  `-./  _.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io        
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |                                  
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
      `-._    `-.__.-&#39;    _.-&#39;                                       
          `-._        _.-&#39;                                           
              `-.__.-&#39;                                               

[6468] 26 Mar 18:37:12.959 # Server started, Redis version 2.8.0
</code></pre><h4 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h4><h5 id="直接关闭"><a href="#直接关闭" class="headerlink" title="直接关闭"></a>直接关闭</h5><pre><code>[root@192 src]# ./redis-cli shutdown
</code></pre><h5 id="指定端口关闭"><a href="#指定端口关闭" class="headerlink" title="指定端口关闭"></a>指定端口关闭</h5><p>启动如果指定了端口，关闭必须指定端口</p>
<pre><code>[root@192 src]# ./redis-cli -p 6379 shutdown 
</code></pre><h5 id="指定端口、ip地址、密码关闭"><a href="#指定端口、ip地址、密码关闭" class="headerlink" title="指定端口、ip地址、密码关闭"></a>指定端口、ip地址、密码关闭</h5><p>启动指定配置文件启动，配置文件修改了端口、密码，关闭的时候必须指定端口、密码</p>
<pre><code>[root@192 src]# ./redis-cli -p 6380 shutdown
(error) NOAUTH Authentication required.
[root@192 src]# ./redis-cli -p 6380 -h 127.0.0.1 -a 000000 shutdown
[root@192 src]# ps -ef | grep redis
root       6526   6337  0 18:51 pts/6    00:00:00 grep redis
[root@192 src]# 
</code></pre><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h4 id="连接服务端"><a href="#连接服务端" class="headerlink" title="连接服务端"></a>连接服务端</h4><h5 id="直接连接"><a href="#直接连接" class="headerlink" title="直接连接"></a>直接连接</h5><p>服务端默认启动，客户端可以直接默认连接</p>
<pre><code>[root@192 src]# ./redis-cli 
127.0.0.1:6379&gt; keys *
1) &quot;b&quot;
2) &quot;hash&quot;
3) &quot;a2&quot;
4) &quot;a1&quot;
5) &quot;1&quot;
6) &quot;hash2&quot;
7) &quot;word&quot;
8) &quot;a&quot;
9) &quot;a3&quot;
127.0.0.1:6379&gt; quit
</code></pre><h5 id="指定端口连接"><a href="#指定端口连接" class="headerlink" title="指定端口连接"></a>指定端口连接</h5><p>服务端指定端口启动，客户端启连接必须指定端口</p>
<pre><code>[root@192 src]# ./redis-cli -p 6379
</code></pre><h5 id="指定端口、ip连接"><a href="#指定端口、ip连接" class="headerlink" title="指定端口、ip连接"></a>指定端口、ip连接</h5><pre><code>[root@192 src]# ./redis-cli -p 6379 -h 127.0.0.1
</code></pre><h5 id="指定端口、ip、密码连接"><a href="#指定端口、ip、密码连接" class="headerlink" title="指定端口、ip、密码连接"></a>指定端口、ip、密码连接</h5><p>服务端指定配置文件启动，配置文件修改了端口、密码，客户端连接必须指定端口、密码</p>
<pre><code>[root@192 src]# pwd
/opt/module/redis-2.8.0/src
[root@192 src]# ./redis-cli -p 6380
127.0.0.1:6380&gt; keys *
(error) NOAUTH Authentication required.
127.0.0.1:6380&gt; quit
[root@192 src]# ./redis-cli -p 6380 -h 127.0.0.1 -a 000000
127.0.0.1:6380&gt; keys *
1) &quot;1&quot;
2) &quot;a&quot;
3) &quot;a2&quot;
4) &quot;hash2&quot;
5) &quot;word&quot;
6) &quot;b&quot;
7) &quot;hash&quot;
8) &quot;a3&quot;
9) &quot;a1&quot;
127.0.0.1:6380&gt; 
</code></pre><h4 id="关闭-1"><a href="#关闭-1" class="headerlink" title="关闭"></a>关闭</h4><pre><code>127.0.0.1:6379&gt; quit
</code></pre><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><h4 id="系统命令"><a href="#系统命令" class="headerlink" title="系统命令"></a>系统命令</h4><h5 id="查看键"><a href="#查看键" class="headerlink" title="查看键"></a>查看键</h5><pre><code>127.0.0.1:6379&gt; keys *
</code></pre><h5 id="查看基本信息"><a href="#查看基本信息" class="headerlink" title="查看基本信息"></a>查看基本信息</h5><pre><code>127.0.0.1:6379&gt; info
</code></pre><h5 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h5><pre><code>127.0.0.1:6379&gt; exit
</code></pre><pre><code>127.0.0.1:6379&gt; quit
</code></pre><h5 id="切换库"><a href="#切换库" class="headerlink" title="切换库"></a>切换库</h5><p>默认使用0库</p>
<pre><code>127.0.0.1:6379&gt; select 2
</code></pre><h5 id="清除当前库数据"><a href="#清除当前库数据" class="headerlink" title="清除当前库数据"></a>清除当前库数据</h5><pre><code>127.0.0.1:6379&gt; flushdb
</code></pre><h5 id="清除所有库数据"><a href="#清除所有库数据" class="headerlink" title="清除所有库数据"></a>清除所有库数据</h5><pre><code>127.0.0.1:6379&gt; flushall
</code></pre><h5 id="查看键的数量"><a href="#查看键的数量" class="headerlink" title="查看键的数量"></a>查看键的数量</h5><pre><code>127.0.0.1:6379&gt; dbsize
</code></pre><h5 id="查看键生命时间"><a href="#查看键生命时间" class="headerlink" title="查看键生命时间"></a>查看键生命时间</h5><p>-1代表永久有效</p>
<pre><code>127.0.0.1:6379[1]&gt; keys  *
1) &quot;a&quot;
2) &quot;b&quot;
127.0.0.1:6379[1]&gt; ttl a
(integer) -1
</code></pre><h5 id="查看类型"><a href="#查看类型" class="headerlink" title="查看类型"></a>查看类型</h5><pre><code>127.0.0.1:6379[1]&gt; type a
string
</code></pre><h5 id="日志监听"><a href="#日志监听" class="headerlink" title="日志监听"></a>日志监听</h5><pre><code>127.0.0.1:6379&gt; monitor
OK
</code></pre><h4 id="String字符串"><a href="#String字符串" class="headerlink" title="String字符串"></a>String字符串</h4><h5 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h5><h6 id="设置单个"><a href="#设置单个" class="headerlink" title="设置单个"></a>设置单个</h6><pre><code>127.0.0.1:6379[1]&gt; set c c
OK
</code></pre><h6 id="设置指定生命时间-秒"><a href="#设置指定生命时间-秒" class="headerlink" title="设置指定生命时间(秒)"></a>设置指定生命时间(秒)</h6><pre><code>127.0.0.1:6379[1]&gt; setex d 10 d
OK
127.0.0.1:6379[1]&gt; ttl d
(integer) 7
127.0.0.1:6379[1]&gt; ttl d
(integer) 6
</code></pre><h6 id="设置指定生命时间-毫秒秒"><a href="#设置指定生命时间-毫秒秒" class="headerlink" title="设置指定生命时间(毫秒秒)"></a>设置指定生命时间(毫秒秒)</h6><pre><code>127.0.0.1:6379[1]&gt; psetex e 10000 e
OK
127.0.0.1:6379[1]&gt; ttl e
(integer) 8
127.0.0.1:6379[1]&gt; ttl e
(integer) 6
127.0.0.1:6379[1]&gt; ttl e
(integer) 5
</code></pre><h6 id="重置单个"><a href="#重置单个" class="headerlink" title="重置单个"></a>重置单个</h6><pre><code>127.0.0.1:6379[1]&gt; get a
&quot;a&quot;
127.0.0.1:6379[1]&gt; getset a aaa
&quot;a&quot;
127.0.0.1:6379[1]&gt; get a
&quot;aaa&quot;
</code></pre><h6 id="设置多个"><a href="#设置多个" class="headerlink" title="设置多个"></a>设置多个</h6><pre><code>127.0.0.1:6379[1]&gt; mset a1 a1_value a2 a2_value a3 a3_value
OK
127.0.0.1:6379[1]&gt; keys *
1) &quot;a&quot;
2) &quot;b&quot;
3) &quot;a1&quot;
4) &quot;a3&quot;
5) &quot;hello&quot;
6) &quot;a2&quot;
7) &quot;c&quot;
127.0.0.1:6379[1]&gt;
</code></pre><h6 id="设置前判断键是否存在setnx"><a href="#设置前判断键是否存在setnx" class="headerlink" title="设置前判断键是否存在setnx"></a>设置前判断键是否存在<code>setnx</code></h6><pre><code>127.0.0.1:6379[1]&gt; keys *
1) &quot;a&quot;
2) &quot;b&quot;
3) &quot;a1&quot;
4) &quot;a3&quot;
5) &quot;hello&quot;
6) &quot;a2&quot;
7) &quot;c&quot;
127.0.0.1:6379[1]&gt; get a
&quot;aaa&quot;
127.0.0.1:6379[1]&gt; setnx a a
(integer) 0
127.0.0.1:6379[1]&gt; get a
&quot;aaa&quot;
</code></pre><h6 id="设置多个，判断键是否存在，只要一个失败就失败"><a href="#设置多个，判断键是否存在，只要一个失败就失败" class="headerlink" title="设置多个，判断键是否存在，只要一个失败就失败"></a>设置多个，判断键是否存在，只要一个失败就失败</h6><pre><code>127.0.0.1:6379[1]&gt; keys *
(empty list or set)
127.0.0.1:6379[1]&gt; msetnx a a b b c c
(integer) 1
127.0.0.1:6379[1]&gt; keys *
1) &quot;a&quot;
2) &quot;b&quot;
3) &quot;c&quot;
</code></pre><h6 id="追加"><a href="#追加" class="headerlink" title="追加"></a>追加</h6><pre><code>
127.0.0.1:6379[1]&gt; append a aaa
(integer) 4
127.0.0.1:6379[1]&gt; get a
&quot;aaaa&quot;
</code></pre><h6 id="默认增长"><a href="#默认增长" class="headerlink" title="默认增长"></a>默认增长</h6><p>只能是数字增长，默认步长是1</p>
<pre><code>127.0.0.1:6379[1]&gt; set 1 1
OK
127.0.0.1:6379[1]&gt; incr 1 
(integer) 2
127.0.0.1:6379[1]&gt; incr 1 
(integer) 3
127.0.0.1:6379[1]&gt; get 1
&quot;3&quot;
</code></pre><h6 id="指定步长增长"><a href="#指定步长增长" class="headerlink" title="指定步长增长"></a>指定步长增长</h6><pre><code>127.0.0.1:6379[1]&gt; get 1
&quot;3&quot;
127.0.0.1:6379[1]&gt; incrby 1 100
(integer) 103
127.0.0.1:6379[1]&gt; incrby 1 100
(integer) 203
127.0.0.1:6379[1]&gt; get 1
&quot;203&quot;
</code></pre><h6 id="默认减值"><a href="#默认减值" class="headerlink" title="默认减值"></a>默认减值</h6><pre><code>127.0.0.1:6379[1]&gt; get 1
&quot;203&quot;
127.0.0.1:6379[1]&gt; decr 1
(integer) 202
127.0.0.1:6379[1]&gt; decr 1
(integer) 201
127.0.0.1:6379[1]&gt; decr 1
(integer) 200
127.0.0.1:6379[1]&gt; get 1
&quot;200&quot;
</code></pre><h6 id="指定步长减值"><a href="#指定步长减值" class="headerlink" title="指定步长减值"></a>指定步长减值</h6><pre><code>127.0.0.1:6379[1]&gt; get 1
&quot;200&quot;
127.0.0.1:6379[1]&gt; decrby 1 20
(integer) 180
127.0.0.1:6379[1]&gt; decrby 1 20
(integer) 160
127.0.0.1:6379[1]&gt; decrby 1 20
(integer) 140
127.0.0.1:6379[1]&gt; get 1
&quot;140&quot;
</code></pre><h5 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h5><h6 id="获取单个"><a href="#获取单个" class="headerlink" title="获取单个"></a>获取单个</h6><pre><code>127.0.0.1:6379[1]&gt; get a
&quot;a&quot;
127.0.0.1:6379[1]&gt; get b
&quot;b&quot;
</code></pre><h6 id="截取"><a href="#截取" class="headerlink" title="截取"></a>截取</h6><pre><code>127.0.0.1:6379[1]&gt; set hello hello
OK
127.0.0.1:6379[1]&gt; getrange hello 0 2
&quot;hel&quot;
</code></pre><h6 id="获取多个"><a href="#获取多个" class="headerlink" title="获取多个"></a>获取多个</h6><pre><code>127.0.0.1:6379[1]&gt; mget a1 a2 a3 
1) &quot;a1_value&quot;
2) &quot;a2_value&quot;
3) &quot;a3_value&quot;
127.0.0.1:6379[1]&gt;
</code></pre><h6 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h6><pre><code>127.0.0.1:6379[1]&gt; get hello
&quot;hello&quot;
127.0.0.1:6379[1]&gt; strlen hello
(integer) 5
</code></pre><h4 id="哈希hash"><a href="#哈希hash" class="headerlink" title="哈希hash"></a>哈希hash</h4><h5 id="设置-1"><a href="#设置-1" class="headerlink" title="设置"></a>设置</h5><h6 id="设置单个-1"><a href="#设置单个-1" class="headerlink" title="设置单个"></a>设置单个</h6><pre><code>127.0.0.1:6379[1]&gt; hset hash username shenlibing
(integer) 1
</code></pre><h6 id="设置多个-1"><a href="#设置多个-1" class="headerlink" title="设置多个"></a>设置多个</h6><pre><code>127.0.0.1:6379[1]&gt; hmset hash address haikou phone 15501892660
OK
127.0.0.1:6379[1]&gt; hgetall hash
1) &quot;username&quot;
2) &quot;shenlibing&quot;
3) &quot;age&quot;
4) &quot;18&quot;
5) &quot;address&quot;
6) &quot;haikou&quot;
7) &quot;phone&quot;
8) &quot;15501892660&quot;
127.0.0.1:6379[1]&gt; hkeys hash
1) &quot;username&quot;
2) &quot;age&quot;
3) &quot;address&quot;
4) &quot;phone&quot;
</code></pre><h6 id="删除多个"><a href="#删除多个" class="headerlink" title="删除多个"></a>删除多个</h6><pre><code>127.0.0.1:6379[1]&gt; hkeys hash
1) &quot;username&quot;
2) &quot;age&quot;
3) &quot;address&quot;
4) &quot;phone&quot;
127.0.0.1:6379[1]&gt; hdel hash address phone
(integer) 2
127.0.0.1:6379[1]&gt; hkeys hash
1) &quot;username&quot;
2) &quot;age&quot;
</code></pre><h6 id="设置单个前判断键是否存在"><a href="#设置单个前判断键是否存在" class="headerlink" title="设置单个前判断键是否存在"></a>设置单个前判断键是否存在</h6><pre><code>127.0.0.1:6379[1]&gt; hsetnx hash username xiaobingbing
(integer) 0
127.0.0.1:6379[1]&gt; hget hash username
&quot;shenlibing&quot;
</code></pre><h5 id="获取-1"><a href="#获取-1" class="headerlink" title="获取"></a>获取</h5><h6 id="获取单个-1"><a href="#获取单个-1" class="headerlink" title="获取单个"></a>获取单个</h6><pre><code>127.0.0.1:6379[1]&gt; hget hash username
&quot;shenlibing&quot;
</code></pre><h6 id="判断键是否存在"><a href="#判断键是否存在" class="headerlink" title="判断键是否存在"></a>判断键是否存在</h6><pre><code>127.0.0.1:6379[1]&gt; hexists hash username
(integer) 1
</code></pre><h6 id="获取整个"><a href="#获取整个" class="headerlink" title="获取整个"></a>获取整个</h6><pre><code>127.0.0.1:6379[1]&gt; hgetall hash
1) &quot;username&quot;
2) &quot;shenlibing&quot;
3) &quot;age&quot;
4) &quot;18&quot;
</code></pre><h6 id="获取键"><a href="#获取键" class="headerlink" title="获取键"></a>获取键</h6><pre><code>127.0.0.1:6379[1]&gt; hkeys hash
1) &quot;username&quot;
2) &quot;age&quot;
</code></pre><h6 id="获取值"><a href="#获取值" class="headerlink" title="获取值"></a>获取值</h6><pre><code>127.0.0.1:6379[1]&gt; hvals hash
1) &quot;shenlibing&quot;
2) &quot;18&quot;
</code></pre><h6 id="获取长度"><a href="#获取长度" class="headerlink" title="获取长度"></a>获取长度</h6><pre><code>127.0.0.1:6379[1]&gt; hlen hash
(integer) 2
</code></pre><h6 id="获取多个-1"><a href="#获取多个-1" class="headerlink" title="获取多个"></a>获取多个</h6><pre><code>127.0.0.1:6379[1]&gt; hmget hash username age
1) &quot;shenlibing&quot;
2) &quot;18&quot;
</code></pre><h4 id="列表list"><a href="#列表list" class="headerlink" title="列表list"></a>列表list</h4><h5 id="设置-2"><a href="#设置-2" class="headerlink" title="设置"></a>设置</h5><h6 id="从左往右进"><a href="#从左往右进" class="headerlink" title="从左往右进"></a>从左往右进</h6><pre><code>127.0.0.1:6379&gt; lpush list 1 2 3 4 5 6 7 8 9 10
(integer) 10
</code></pre><h6 id="重置"><a href="#重置" class="headerlink" title="重置"></a>重置</h6><p>根据索引重置某个元素</p>
<pre><code>127.0.0.1:6379&gt; lset list 0 100
OK
</code></pre><h6 id="向左弹出"><a href="#向左弹出" class="headerlink" title="向左弹出"></a>向左弹出</h6><pre><code>127.0.0.1:6379&gt; lpop list
&quot;100&quot;
</code></pre><h6 id="向右弹出"><a href="#向右弹出" class="headerlink" title="向右弹出"></a>向右弹出</h6><pre><code>127.0.0.1:6379&gt; rpop list
&quot;1&quot;
</code></pre><h5 id="获取-2"><a href="#获取-2" class="headerlink" title="获取"></a>获取</h5><h6 id="获取多个-2"><a href="#获取多个-2" class="headerlink" title="获取多个"></a>获取多个</h6><p>根据索引截取<code>list</code>元素，获取多个元素</p>
<pre><code>127.0.0.1:6379&gt; lrange list 0 2
1) &quot;10&quot;
2) &quot;9&quot;
3) &quot;8&quot;
</code></pre><h6 id="获取单个-2"><a href="#获取单个-2" class="headerlink" title="获取单个"></a>获取单个</h6><p>根据索引查找<code>list</code>中某个元素，获取单个元素</p>
<pre><code>127.0.0.1:6379&gt; lindex list 0
&quot;100&quot;
</code></pre><h6 id="长度-1"><a href="#长度-1" class="headerlink" title="长度"></a>长度</h6><pre><code>127.0.0.1:6379&gt; llen list
(integer) 10
</code></pre><h6 id="获取所有"><a href="#获取所有" class="headerlink" title="获取所有"></a>获取所有</h6><pre><code>127.0.0.1:6379&gt; llen list
(integer) 8
127.0.0.1:6379&gt; lrange list 0 7
1) &quot;9&quot;
2) &quot;8&quot;
3) &quot;7&quot;
4) &quot;6&quot;
5) &quot;5&quot;
6) &quot;4&quot;
7) &quot;3&quot;
8) &quot;2&quot;
</code></pre><h4 id="集合set"><a href="#集合set" class="headerlink" title="集合set"></a>集合set</h4><p>无序，不允许重复</p>
<h5 id="设置-3"><a href="#设置-3" class="headerlink" title="设置"></a>设置</h5><h6 id="设置多个-2"><a href="#设置多个-2" class="headerlink" title="设置多个"></a>设置多个</h6><pre><code>127.0.0.1:6379&gt; sadd set a b c d
(integer) 4
</code></pre><h6 id="重命名"><a href="#重命名" class="headerlink" title="重命名"></a>重命名</h6><pre><code>127.0.0.1:6379&gt; rename set set1
OK
</code></pre><h6 id="删除指定元素-一个或者多个"><a href="#删除指定元素-一个或者多个" class="headerlink" title="删除指定元素,一个或者多个"></a>删除指定元素,一个或者多个</h6><pre><code>127.0.0.1:6379&gt; srem set1 a b
(integer) 2
127.0.0.1:6379&gt; srem set1 c
(integer) 1
</code></pre><h6 id="随机删除一个元素"><a href="#随机删除一个元素" class="headerlink" title="随机删除一个元素"></a>随机删除一个元素</h6><pre><code>127.0.0.1:6379&gt; spop set2
&quot;f&quot;
</code></pre><h5 id="获取-3"><a href="#获取-3" class="headerlink" title="获取"></a>获取</h5><h6 id="长度-2"><a href="#长度-2" class="headerlink" title="长度"></a>长度</h6><pre><code>127.0.0.1:6379&gt; scard set1
(integer) 4
</code></pre><h6 id="获取所有-1"><a href="#获取所有-1" class="headerlink" title="获取所有"></a>获取所有</h6><pre><code>127.0.0.1:6379&gt; smembers set2
1) &quot;d&quot;
2) &quot;e&quot;
3) &quot;c&quot;
4) &quot;f&quot;
</code></pre><h6 id="差集"><a href="#差集" class="headerlink" title="差集"></a>差集</h6><pre><code>127.0.0.1:6379&gt; smembers set1 
1) &quot;d&quot;
2) &quot;b&quot;
3) &quot;c&quot;
4) &quot;a&quot;
127.0.0.1:6379&gt; smembers set2
1) &quot;d&quot;
2) &quot;e&quot;
3) &quot;c&quot;
4) &quot;f&quot;
127.0.0.1:6379&gt; sdiff set1 set2
1) &quot;b&quot;
2) &quot;a&quot;
</code></pre><pre><code>127.0.0.1:6379&gt; sdiff set2 set1
1) &quot;e&quot;
2) &quot;f&quot;
</code></pre><h6 id="交集"><a href="#交集" class="headerlink" title="交集"></a>交集</h6><pre><code>127.0.0.1:6379&gt; sinter set1 set2
1) &quot;c&quot;
2) &quot;d&quot;
</code></pre><h6 id="并集"><a href="#并集" class="headerlink" title="并集"></a>并集</h6><pre><code>127.0.0.1:6379&gt; sunion set1 set2
1) &quot;c&quot;
2) &quot;e&quot;
3) &quot;f&quot;
4) &quot;a&quot;
5) &quot;b&quot;
6) &quot;d&quot;
</code></pre><h6 id="是否存在某个元素"><a href="#是否存在某个元素" class="headerlink" title="是否存在某个元素"></a>是否存在某个元素</h6><pre><code>127.0.0.1:6379&gt; sismember set1 a
(integer) 1
</code></pre><h4 id="有序集合sortedset"><a href="#有序集合sortedset" class="headerlink" title="有序集合sortedset"></a>有序集合sortedset</h4><h5 id="设置-4"><a href="#设置-4" class="headerlink" title="设置"></a>设置</h5><h6 id="根据分数设置"><a href="#根据分数设置" class="headerlink" title="根据分数设置"></a>根据分数设置</h6><pre><code>127.0.0.1:6379&gt; zadd sortedset1 100 a 200 b 300 c
(integer) 3
</code></pre><h6 id="重命名-1"><a href="#重命名-1" class="headerlink" title="重命名"></a>重命名</h6><pre><code>127.0.0.1:6379&gt; rename sortedset1 sortedset
OK
</code></pre><h6 id="加分数"><a href="#加分数" class="headerlink" title="加分数"></a>加分数</h6><pre><code>127.0.0.1:6379&gt; zincrby sortedset 1000 a
&quot;1100&quot;
127.0.0.1:6379&gt; zrank sortedset a
(integer) 2
</code></pre><h5 id="获取-4"><a href="#获取-4" class="headerlink" title="获取"></a>获取</h5><h6 id="长度-3"><a href="#长度-3" class="headerlink" title="长度"></a>长度</h6><pre><code>127.0.0.1:6379&gt; zcard sortedset
(integer) 3
</code></pre><h6 id="获取分数"><a href="#获取分数" class="headerlink" title="获取分数"></a>获取分数</h6><p>获取元素的分数</p>
<pre><code>127.0.0.1:6379&gt; zscore sortedset a
&quot;100&quot;
</code></pre><h6 id="根据分数范围返回成员个数"><a href="#根据分数范围返回成员个数" class="headerlink" title="根据分数范围返回成员个数"></a>根据分数范围返回成员个数</h6><pre><code>127.0.0.1:6379&gt; zcount sortedset 0 200
(integer) 2
127.0.0.1:6379&gt; zcount sortedset 0 300
(integer) 3
</code></pre><h6 id="获取元素索引"><a href="#获取元素索引" class="headerlink" title="获取元素索引"></a>获取元素索引</h6><pre><code>127.0.0.1:6379&gt; zrank sortedset a
(integer) 0
127.0.0.1:6379&gt; zrank sortedset b
(integer) 1
</code></pre><h6 id="根据索引区间返回元素"><a href="#根据索引区间返回元素" class="headerlink" title="根据索引区间返回元素"></a>根据索引区间返回元素</h6><p>可以带分数显示</p>
<pre><code>127.0.0.1:6379&gt; zcard sortedset
(integer) 3
127.0.0.1:6379&gt; zrange sortedset 0 2
1) &quot;b&quot;
2) &quot;c&quot;
3) &quot;a&quot;
127.0.0.1:6379&gt; zrange sortedset 0 2 withscores
1) &quot;b&quot;
2) &quot;200&quot;
3) &quot;c&quot;
4) &quot;300&quot;
5) &quot;a&quot;
6) &quot;1100&quot;
</code></pre><h3 id="Redis-Desktop-Manager工具"><a href="#Redis-Desktop-Manager工具" class="headerlink" title="Redis_Desktop_Manager工具"></a>Redis_Desktop_Manager工具</h3><p><a href="https://redisdesktop.com/download" target="_blank" rel="noopener">下载</a></p>
<p><a href="http://learning.happymmall.com/%E4%BA%8C%E6%9C%9F%E9%9B%86%E7%BE%A4%E5%8F%8A%E7%BC%93%E5%AD%98%E5%88%86%E5%B8%83%E5%BC%8FJava%E7%AB%AF/redis-desktop-manager-088-windows.exe" target="_blank" rel="noopener">下载2</a></p>
<p><a href="http://docs.redisdesktop.com/en/latest/quick-start/" target="_blank" rel="noopener">Quick Start</a></p>
<h2 id="原生单点登录"><a href="#原生单点登录" class="headerlink" title="原生单点登录"></a>原生单点登录</h2><p>原生Redis+Cookie+Jackson+Filter解决session共享问题实现单点登录</p>
<h3 id="java使用Jedis客户端"><a href="#java使用Jedis客户端" class="headerlink" title="java使用Jedis客户端"></a>java使用Jedis客户端</h3><h4 id="编辑pom-xml"><a href="#编辑pom-xml" class="headerlink" title="编辑pom.xml"></a>编辑<code>pom.xml</code></h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="获取连接"><a href="#获取连接" class="headerlink" title="获取连接"></a>获取连接</h4><p>从连接池获取连接</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PropertiesUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>Jedis<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>JedisPool<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>JedisPoolConfig<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisPool</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//jedis连接池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> JedisPool pool<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//最大连接数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer maxTotal <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.max.total"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在jedispool中最大的idle状态(空闲的)的jedis实例的个数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer maxIdle <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.max.idle"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在jedispool中最小的idle状态(空闲的)的jedis实例的个数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer minIdle <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.min.idle"</span><span class="token punctuation">,</span> <span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//在borrow一个jedis实例的时候，是否要进行验证操作，如果赋值true。则得到的jedis实例肯定是可以用的。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Boolean testOnBorrow <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.test.borrow"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在return一个jedis实例的时候，是否要进行验证操作，如果赋值true。则放回jedispool的jedis实例肯定是可以用的。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Boolean testOnReturn <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.test.return"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String redisIp <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.ip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer redisPort <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JedisPoolConfig config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span>minIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">setTestOnBorrow</span><span class="token punctuation">(</span>testOnBorrow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setTestOnReturn</span><span class="token punctuation">(</span>testOnReturn<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">//连接耗尽的时候，是否阻塞，false会抛出异常，true阻塞直到超时。默认为true。</span>
        config<span class="token punctuation">.</span><span class="token function">setBlockWhenExhausted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> redisIp<span class="token punctuation">,</span> redisPort<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Jedis <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>Jedis jedis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">returnResource</span><span class="token punctuation">(</span>Jedis jedis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"geelykey"</span><span class="token punctuation">,</span> <span class="token string">"geelyvalue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//临时调用，销毁连接池中的所有连接</span>
        pool<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"program is end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Jedis-API封装"><a href="#Jedis-API封装" class="headerlink" title="Jedis API封装"></a>Jedis API封装</h4><p>读写数据</p>
<pre class=" language-java"><code class="language-java">
<span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RedisPool<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>Jedis<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisPoolUtil</span> <span class="token punctuation">{</span>


    <span class="token comment" spellcheck="true">/**
     * 设置key的有效期，单位是秒
     * @param key
     * @param exTime
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">expire</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span><span class="token keyword">int</span> exTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Long result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>exTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"expire key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//exTime的单位是秒</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">setEx</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">,</span><span class="token keyword">int</span> exTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>exTime<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"setex key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">set</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"set key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"get key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">del</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Long result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"del key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Jedis jedis <span class="token operator">=</span> RedisPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String value <span class="token operator">=</span> RedisPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">setEx</span><span class="token punctuation">(</span><span class="token string">"keyex"</span><span class="token punctuation">,</span><span class="token string">"valueex"</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        String aaa <span class="token operator">=</span> RedisPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aaa<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre>
<h3 id="Jackson封装JacksonUtil"><a href="#Jackson封装JacksonUtil" class="headerlink" title="Jackson封装JacksonUtil"></a>Jackson封装JacksonUtil</h3><h4 id="编辑pom-xml-1"><a href="#编辑pom-xml-1" class="headerlink" title="编辑pom.xml"></a>编辑<code>pom.xml</code></h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.codehaus.jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-mapper-asl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.9.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="多泛型序列化和反序列化"><a href="#多泛型序列化和反序列化" class="headerlink" title="多泛型序列化和反序列化"></a>多泛型序列化和反序列化</h4><pre class=" language-java"><code class="language-java">
<span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span>Lists<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Category<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>TestPojo<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>map<span class="token punctuation">.</span>DeserializationConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>map<span class="token punctuation">.</span>ObjectMapper<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>map<span class="token punctuation">.</span>SerializationConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>map<span class="token punctuation">.</span>annotate<span class="token punctuation">.</span>JsonSerialize<span class="token punctuation">.</span>Inclusion<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>type<span class="token punctuation">.</span>JavaType<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>type<span class="token punctuation">.</span>TypeReference<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>SimpleDateFormat<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> ObjectMapper objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//对象的所有字段全部列入</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">setSerializationInclusion</span><span class="token punctuation">(</span>Inclusion<span class="token punctuation">.</span>ALWAYS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//取消默认转换timestamps形式</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>SerializationConfig<span class="token punctuation">.</span>Feature<span class="token punctuation">.</span>WRITE_DATES_AS_TIMESTAMPS<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//忽略空Bean转json的错误</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>SerializationConfig<span class="token punctuation">.</span>Feature<span class="token punctuation">.</span>FAIL_ON_EMPTY_BEANS<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//所有的日期格式都统一为以下的样式，即yyyy-MM-dd HH:mm:ss</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">setDateFormat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span>DateTimeUtil<span class="token punctuation">.</span>STANDARD_FORMAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//忽略 在json字符串中存在，但是在java对象中不存在对应属性的情况。防止错误</span>
        objectMapper<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>DeserializationConfig<span class="token punctuation">.</span>Feature<span class="token punctuation">.</span>FAIL_ON_UNKNOWN_PROPERTIES<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> String <span class="token function">obj2String</span><span class="token punctuation">(</span>T obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token operator">?</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>obj <span class="token operator">:</span>  objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse Object to String error"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> String <span class="token function">obj2StringPretty</span><span class="token punctuation">(</span>T obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token operator">?</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>obj <span class="token operator">:</span>  objectMapper<span class="token punctuation">.</span><span class="token function">writerWithDefaultPrettyPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse Object to String error"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">string2Obj</span><span class="token punctuation">(</span>String str<span class="token punctuation">,</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> clazz<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">||</span> clazz <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>str <span class="token operator">:</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse String to Object error"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">string2Obj</span><span class="token punctuation">(</span>String str<span class="token punctuation">,</span> TypeReference<span class="token operator">&lt;</span>T<span class="token operator">></span> typeReference<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">||</span> typeReference <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">(</span>typeReference<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">?</span> str <span class="token operator">:</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>typeReference<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse String to Object error"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">string2Obj</span><span class="token punctuation">(</span>String str<span class="token punctuation">,</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> collectionClass<span class="token punctuation">,</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> elementClasses<span class="token punctuation">)</span><span class="token punctuation">{</span>
        JavaType javaType <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">getTypeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">constructParametricType</span><span class="token punctuation">(</span>collectionClass<span class="token punctuation">,</span>elementClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>javaType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse String to Object error"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TestPojo testPojo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testPojo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Geely"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        testPojo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//{"name":"Geely","id":666}</span>
        String json <span class="token operator">=</span> <span class="token string">"{\"name\":\"Geely\",\"color\":\"blue\",\"id\":666}"</span><span class="token punctuation">;</span>
        TestPojo testPojoObject <span class="token operator">=</span> JsonUtil<span class="token punctuation">.</span><span class="token function">string2Obj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span>TestPojo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        String testPojoJson = JsonUtil.obj2String(testPojo);</span>
<span class="token comment" spellcheck="true">//        log.info("testPojoJson:{}",testPojoJson);</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">//        User user = new User();</span>
<span class="token comment" spellcheck="true">//        user.setId(2);</span>
<span class="token comment" spellcheck="true">//        user.setEmail("geely@happymmall.com");</span>
<span class="token comment" spellcheck="true">//        user.setCreateTime(new Date());</span>
<span class="token comment" spellcheck="true">//        String userJsonPretty = JsonUtil.obj2StringPretty(user);</span>
<span class="token comment" spellcheck="true">//        log.info("userJson:{}",userJsonPretty);</span>


<span class="token comment" spellcheck="true">//        User u2 = new User();</span>
<span class="token comment" spellcheck="true">//        u2.setId(2);</span>
<span class="token comment" spellcheck="true">//        u2.setEmail("geelyu2@happymmall.com");</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        String user1Json = JsonUtil.obj2String(u1);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        String user1JsonPretty = JsonUtil.obj2StringPretty(u1);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        log.info("user1Json:{}",user1Json);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        log.info("user1JsonPretty:{}",user1JsonPretty);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        User user = JsonUtil.string2Obj(user1Json,User.class);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        List&lt;User> userList = Lists.newArrayList();</span>
<span class="token comment" spellcheck="true">//        userList.add(u1);</span>
<span class="token comment" spellcheck="true">//        userList.add(u2);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        String userListStr = JsonUtil.obj2StringPretty(userList);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        log.info("==================");</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        log.info(userListStr);</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        List&lt;User> userListObj1 = JsonUtil.string2Obj(userListStr, new TypeReference&lt;List&lt;User>>() {</span>
<span class="token comment" spellcheck="true">//        });</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//        List&lt;User> userListObj2 = JsonUtil.string2Obj(userListStr,List.class,User.class);</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="Cookie封装"><a href="#Cookie封装" class="headerlink" title="Cookie封装"></a>Cookie封装</h3><p>其中<code>COOKIE_NAME</code>和<code>COOKIE_DOMAIN</code>是根据实际项目，线上的域名来配置的，如果扩展开来讲，对于里面每个属性，在二级/三级域名下的读写问题是必须要细化的</p>
<p>Cookie的读、写、删</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>Cookie<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String COOKIE_DOMAIN <span class="token operator">=</span> <span class="token string">".happymmall.com"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String COOKIE_NAME <span class="token operator">=</span> <span class="token string">"mmall_login_token"</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">readLoginToken</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Cookie<span class="token punctuation">[</span><span class="token punctuation">]</span> cks <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cks <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>Cookie ck <span class="token operator">:</span> cks<span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"read cookieName:{},cookieValue:{}"</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>COOKIE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"return cookieName:{},cookieValue:{}"</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> ck<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//X:domain=".happymmall.com"</span>
    <span class="token comment" spellcheck="true">//a:A.happymmall.com            cookie:domain=A.happymmall.com;path="/"</span>
    <span class="token comment" spellcheck="true">//b:B.happymmall.com            cookie:domain=B.happymmall.com;path="/"</span>
    <span class="token comment" spellcheck="true">//c:A.happymmall.com/test/cc    cookie:domain=A.happymmall.com;path="/test/cc"</span>
    <span class="token comment" spellcheck="true">//d:A.happymmall.com/test/dd    cookie:domain=A.happymmall.com;path="/test/dd"</span>
    <span class="token comment" spellcheck="true">//e:A.happymmall.com/test       cookie:domain=A.happymmall.com;path="/test"</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeLoginToken</span><span class="token punctuation">(</span>HttpServletResponse response<span class="token punctuation">,</span>String token<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Cookie ck <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>COOKIE_NAME<span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ck<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>COOKIE_DOMAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ck<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//代表设置在根目录</span>
        ck<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//单位是秒。</span>
        <span class="token comment" spellcheck="true">//如果这个maxage不设置的话，cookie就不会写入硬盘，而是写在内存。只在当前页面有效。</span>
        ck<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">365</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//如果是-1，代表永久</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"write cookieName:{},cookieValue:{}"</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>ck<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delLoginToken</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span>HttpServletResponse response<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Cookie<span class="token punctuation">[</span><span class="token punctuation">]</span> cks <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cks <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>Cookie ck <span class="token operator">:</span> cks<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>COOKIE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    ck<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span>COOKIE_DOMAIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ck<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ck<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置成0，代表删除此cookie。</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"del cookieName:{},cookieValue:{}"</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ck<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>ck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="SessionExpireFilter构建Session时间重置过滤器"><a href="#SessionExpireFilter构建Session时间重置过滤器" class="headerlink" title="SessionExpireFilter构建Session时间重置过滤器"></a>SessionExpireFilter构建Session时间重置过滤器</h3><h4 id="编辑web-xml"><a href="#编辑web-xml" class="headerlink" title="编辑web.xml"></a>编辑<code>web.xml</code></h4><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>sessionExpireFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>com.mmall.controller.common.SessionExpireFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>sessionExpireFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="时间重置过滤器类"><a href="#时间重置过滤器类" class="headerlink" title="时间重置过滤器类"></a>时间重置过滤器类</h4><p>SessionExpireFilter.java</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>common<span class="token punctuation">;</span>


<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Const<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>CookieUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>JsonUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>RedisShardedPoolUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>FilterChain<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>FilterConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletException<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ServletResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SessionExpireFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>FilterConfig filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        HttpServletRequest httpServletRequest <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span>servletRequest<span class="token punctuation">;</span>

        String loginToken <span class="token operator">=</span> CookieUtil<span class="token punctuation">.</span><span class="token function">readLoginToken</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>loginToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//判断logintoken是否为空或者""；</span>
            <span class="token comment" spellcheck="true">//如果不为空的话，符合条件，继续拿user信息</span>

            String userJsonStr <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loginToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            User user <span class="token operator">=</span> JsonUtil<span class="token punctuation">.</span><span class="token function">string2Obj</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//如果user不为空，则重置session的时间，即调用expire命令</span>
                RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>loginToken<span class="token punctuation">,</span> Const<span class="token punctuation">.</span>RedisCacheExtime<span class="token punctuation">.</span>REDIS_SESSION_EXTIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span>servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Guava-Cache迁移Redis分布式缓存"><a href="#Guava-Cache迁移Redis分布式缓存" class="headerlink" title="Guava Cache迁移Redis分布式缓存"></a>Guava Cache迁移Redis分布式缓存</h3><p>描述：修改密码时需要验证<code>token</code>，<code>token</code>的生成是在校验忘记密码的问题答案是正确的时候生成，如果答案是正确的话，返回给前台。重置密码发起请求携带该<code>token</code>到后台校验是否一致。</p>
<h4 id="集群后Guava-Cache的不足"><a href="#集群后Guava-Cache的不足" class="headerlink" title="集群后Guava Cache的不足"></a>集群后Guava Cache的不足</h4><p><code>Tomcat</code>之前使用的<code>guava cache</code>存储<code>token</code>，它只存在于<code>tomcat</code>实例上，<code>tomcat</code>及<code>tomcat</code>之间并不共享，所以必须迁移。否则负载均衡就<code>TomcatA</code>存储了<code>guava cache</code>，<code>TomcatB</code>想拿就拿不到了</p>
<h4 id="Guava-Cache迁移Redis缓存"><a href="#Guava-Cache迁移Redis缓存" class="headerlink" title="Guava Cache迁移Redis缓存"></a>Guava Cache迁移Redis缓存</h4><h5 id="修改前"><a href="#修改前" class="headerlink" title="修改前"></a>修改前</h5><p><code>guava cache</code>存储<code>token</code></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">checkAnswer</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span>String question<span class="token punctuation">,</span>String answer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> resultCount <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">checkAnswer</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>question<span class="token punctuation">,</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>resultCount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//说明问题及问题答案是这个用户的,并且是正确的</span>
        String forgetToken <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TokenCache<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>TokenCache<span class="token punctuation">.</span>TOKEN_PREFIX<span class="token operator">+</span>username<span class="token punctuation">,</span>forgetToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createBySuccess</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"问题的答案错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">forgetResetPassword</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span>String passwordNew<span class="token punctuation">,</span>String forgetToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"参数错误,token需要传递"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ServerResponse validResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkValid</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>Const<span class="token punctuation">.</span>USERNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>validResponse<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//用户不存在</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    String token <span class="token operator">=</span> TokenCache<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>TokenCache<span class="token punctuation">.</span>TOKEN_PREFIX<span class="token operator">+</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"token无效或者过期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        String md5Password  <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">MD5EncodeUtf8</span><span class="token punctuation">(</span>passwordNew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rowCount <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updatePasswordByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>md5Password<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>rowCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createBySuccessMessage</span><span class="token punctuation">(</span><span class="token string">"修改密码成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"token错误,请重新获取重置密码的token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"修改密码失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="修改后"><a href="#修改后" class="headerlink" title="修改后"></a>修改后</h5><p>后台<code>token</code>保存在<code>Redis</code>上</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">checkAnswer</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span>String question<span class="token punctuation">,</span>String answer<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> resultCount <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">checkAnswer</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>question<span class="token punctuation">,</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>resultCount<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//说明问题及问题答案是这个用户的,并且是正确的</span>
        String forgetToken <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">setEx</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>TOKEN_PREFIX<span class="token operator">+</span>username<span class="token punctuation">,</span>forgetToken<span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createBySuccess</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"问题的答案错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">forgetResetPassword</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span>String passwordNew<span class="token punctuation">,</span>String forgetToken<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"参数错误,token需要传递"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ServerResponse validResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkValid</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>Const<span class="token punctuation">.</span>USERNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>validResponse<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//用户不存在</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    String token <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>TOKEN_PREFIX<span class="token operator">+</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"token无效或者过期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>forgetToken<span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        String md5Password  <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">MD5EncodeUtf8</span><span class="token punctuation">(</span>passwordNew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rowCount <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updatePasswordByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>md5Password<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>rowCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createBySuccessMessage</span><span class="token punctuation">(</span><span class="token string">"修改密码成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"token错误,请重新获取重置密码的token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"修改密码失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="Redis分布式环境搭建"><a href="#Redis分布式环境搭建" class="headerlink" title="Redis分布式环境搭建"></a>Redis分布式环境搭建</h2><p>第一个Redis不变，修改第二个Redis</p>
<h3 id="编辑redis-conf"><a href="#编辑redis-conf" class="headerlink" title="编辑redis.conf"></a>编辑<code>redis.conf</code></h3><p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/Redis%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3.png" alt></p>
<h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><p>第一个默认启动,默认端口6379</p>
<pre><code>[root@192 src]# ./redis-server &amp;
</code></pre><p>第二个指定配置文件启动，修改后的端口6380</p>
<pre><code>[root@192 src]# ./redis-server ../redis.conf &amp;
</code></pre><h3 id="java代码连接Redis分布式缓存"><a href="#java代码连接Redis分布式缓存" class="headerlink" title="java代码连接Redis分布式缓存"></a>java代码连接Redis分布式缓存</h3><p>一致性算法</p>
<h4 id="获取连接-1"><a href="#获取连接-1" class="headerlink" title="获取连接"></a>获取连接</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PropertiesUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>JedisPoolConfig<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>JedisShardInfo<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>ShardedJedis<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>ShardedJedisPool<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Hashing<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Sharded<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisShardedPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> ShardedJedisPool pool<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sharded jedis连接池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer maxTotal <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.max.total"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//最大连接数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer maxIdle <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.max.idle"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在jedispool中最大的idle状态(空闲的)的jedis实例的个数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer minIdle <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.min.idle"</span><span class="token punctuation">,</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在jedispool中最小的idle状态(空闲的)的jedis实例的个数</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> Boolean testOnBorrow <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.test.borrow"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在borrow一个jedis实例的时候，是否要进行验证操作，如果赋值true。则得到的jedis实例肯定是可以用的。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Boolean testOnReturn <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis.test.return"</span><span class="token punctuation">,</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//在return一个jedis实例的时候，是否要进行验证操作，如果赋值true。则放回jedispool的jedis实例肯定是可以用的。</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String redis1Ip <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis1.ip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer redis1Port <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis1.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> String redis2Ip <span class="token operator">=</span> PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis2.ip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Integer redis2Port <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"redis2.port"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>




    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        JedisPoolConfig config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span>minIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        config<span class="token punctuation">.</span><span class="token function">setTestOnBorrow</span><span class="token punctuation">(</span>testOnBorrow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">setTestOnReturn</span><span class="token punctuation">(</span>testOnReturn<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//连接耗尽的时候，是否阻塞，false会抛出异常，true阻塞直到超时。默认为true。</span>
        config<span class="token punctuation">.</span><span class="token function">setBlockWhenExhausted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        JedisShardInfo info1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisShardInfo</span><span class="token punctuation">(</span>redis1Ip<span class="token punctuation">,</span>redis1Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        JedisShardInfo info2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisShardInfo</span><span class="token punctuation">(</span>redis2Ip<span class="token punctuation">,</span>redis2Port<span class="token punctuation">,</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>JedisShardInfo<span class="token operator">></span> jedisShardInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>JedisShardInfo<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        jedisShardInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>info1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedisShardInfoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>info2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShardedJedisPool</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>jedisShardInfoList<span class="token punctuation">,</span> Hashing<span class="token punctuation">.</span>MURMUR_HASH<span class="token punctuation">,</span> Sharded<span class="token punctuation">.</span>DEFAULT_KEY_TAG_PATTERN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span><span class="token punctuation">{</span>
        <span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> ShardedJedis <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>ShardedJedis jedis<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">returnResource</span><span class="token punctuation">(</span>ShardedJedis jedis<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token string">"value"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//        pool.destroy();//临时调用，销毁连接池中的所有连接</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"program is end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="读写数据"><a href="#读写数据" class="headerlink" title="读写数据"></a>读写数据</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">.</span>RedisShardedPool<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis<span class="token punctuation">.</span>ShardedJedis<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisShardedPoolUtil</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 设置key的有效期，单位是秒
     * @param key
     * @param exTime
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">expire</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span><span class="token keyword">int</span> exTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Long result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>exTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"expire key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//exTime的单位是秒</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">setEx</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">,</span><span class="token keyword">int</span> exTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>exTime<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"setex key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">set</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"set key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getSet</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">getSet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"getset key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">get</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"get key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">del</span><span class="token punctuation">(</span>String key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Long result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"del key:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Long <span class="token function">setnx</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span>String value<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Long result <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"setnx key:{} value:{} error"</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span>value<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnBrokenResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RedisShardedPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ShardedJedis jedis <span class="token operator">=</span> RedisShardedPool<span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        String value <span class="token operator">=</span> RedisPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">setEx</span><span class="token punctuation">(</span><span class="token string">"keyex"</span><span class="token punctuation">,</span><span class="token string">"valueex"</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        RedisPoolUtil<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">"keyTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        String aaa <span class="token operator">=</span> RedisPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>aaa<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h2 id="Spring-Session单点登录"><a href="#Spring-Session单点登录" class="headerlink" title="Spring Session单点登录"></a>Spring Session单点登录</h2><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://spring.io/projects/spring-session" target="_blank" rel="noopener">官网</a></p>
<p><a href="https://docs.spring.io/spring-session/docs/current/reference/html5/" target="_blank" rel="noopener">官方文档</a></p>
<p><a href="https://github.com/spring-projects/spring-session/tree/1.2.x" target="_blank" rel="noopener">GitHub地址</a></p>
<p><a href="https://docs.spring.io/spring-session/docs/current/reference/html5/guides/java-redis.html" target="_blank" rel="noopener">Quick Start</a></p>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- spring session 单点登录 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="Spring-Session整合Redis"><a href="#Spring-Session整合Redis" class="headerlink" title="Spring Session整合Redis"></a>Spring Session整合Redis</h3><p><code>applicationContext.xml</code>引入整合配置文件</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>applicationContext-spring-session.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
<p>新建<code>applicationContext-spring-session.xml</code>资源文件</p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/aop<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>tx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/tx<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>jdbc</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/jdbc<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>
     http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
     http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
     http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>redisHttpSessionConfiguration<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.session.data.redis.config.annotation.web.http.RedisHttpSessionConfiguration<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxInactiveIntervalInSeconds<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1800<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>defaultCookieSerializer<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.session.web.http.DefaultCookieSerializer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>domainName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>useHttpOnlyCookie<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cookiePath<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cookieMaxAge<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>31536000<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisPoolConfig<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>redis.clients.jedis.JedisPoolConfig<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maxTotal<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisConnectionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.data.redis.connection.jedis.JedisConnectionFactory<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hostName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>192.168.1.104<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>port<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>6379<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>poolConfig<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jedisPoolConfig<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span>

</code></pre>
<h3 id="配置web-xml"><a href="#配置web-xml" class="headerlink" title="配置web.xml"></a>配置<code>web.xml</code></h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>这里的<code>session</code>是经过包装过的代理类</p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/%E5%8C%85%E8%A3%85%E4%BB%A3%E7%90%86%E7%B1%BB.png" alt></p>
<pre><code>session.setAttribute(Const.CURRENT_USER,response.getData());
session.removeAttribute(Const.CURRENT_USER);
User user = (User)session.getAttribute(Const.CURRENT_USER);
</code></pre><h3 id="坑-1"><a href="#坑-1" class="headerlink" title="坑"></a>坑</h3><h4 id="Caused-by-org-springframework-beans-factory-NoSuchBeanDefinitionException-No-qualifying-bean-of-type-org-springframework-session-SessionRepository-found-for-dependency-expected-at-least-1-bean-which-qualifies-as-autowire-candidate-for-this-dependency-Dependency-annotations"><a href="#Caused-by-org-springframework-beans-factory-NoSuchBeanDefinitionException-No-qualifying-bean-of-type-org-springframework-session-SessionRepository-found-for-dependency-expected-at-least-1-bean-which-qualifies-as-autowire-candidate-for-this-dependency-Dependency-annotations" class="headerlink" title="Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type [org.springframework.session.SessionRepository] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency. Dependency annotations: {}"></a>Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type [org.springframework.session.SessionRepository] found for dependency: expected at least 1 bean which qualifies as autowire candidate for this dependency. Dependency annotations: {}</h4><p>描述： 启动报错</p>
<p>解决：修改<code>&lt;org.springframework.version&gt;4.0.0.RELEASE&lt;/org.springframework.version&gt;</code>为<br> <code>&lt;org.springframework.version&gt;4.0.3.RELEASE&lt;/org.springframework.version&gt;</code></p>
<h4 id="No-bean-named-‘springSessionRepositoryFilter’-is-defined"><a href="#No-bean-named-‘springSessionRepositoryFilter’-is-defined" class="headerlink" title="No bean named ‘springSessionRepositoryFilter’ is defined"></a>No bean named ‘springSessionRepositoryFilter’ is defined</h4><p>描述：启动报错，容器找不到该<code>bean</code></p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>org.springframework.web.filter.DelegatingFilterProxy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>springSessionRepositoryFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<p>解决：</p>
<p><code>spring</code>配置文件没有引入<code>spring-session</code>整合配置文件</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>applicationContext-spring-session.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
<h2 id="SpringMVC全局异常控制"><a href="#SpringMVC全局异常控制" class="headerlink" title="SpringMVC全局异常控制"></a>SpringMVC全局异常控制</h2><h3 id="Spring及SpringMVC包扫描隔离"><a href="#Spring及SpringMVC包扫描隔离" class="headerlink" title="Spring及SpringMVC包扫描隔离"></a>Spring及SpringMVC包扫描隔离</h3><h4 id="Spring扫描"><a href="#Spring扫描" class="headerlink" title="Spring扫描"></a>Spring扫描</h4><p>排除<code>controller</code>扫描注解</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.mmall<span class="token punctuation">"</span></span> <span class="token attr-name">annotation-config</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>exclude-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="SpringMVC扫描"><a href="#SpringMVC扫描" class="headerlink" title="SpringMVC扫描"></a>SpringMVC扫描</h4><pre class=" language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--springmvc扫描包指定到controller，防止重复扫描
    use-default-filters="false" 关闭默认扫描
 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.mmall.controller<span class="token punctuation">"</span></span> <span class="token attr-name">annotation-config</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">use-default-filters</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>include-filter</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>annotation<span class="token punctuation">"</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.springframework.stereotype.Controller<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">context:</span>component-scan</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="Component注解"><a href="#Component注解" class="headerlink" title="@Component注解"></a>@Component注解</h3><p>异常包装类<code>ExceptionResolver.java</code>,必须要加上<code>@Component</code>注解，使其成为容器中的<code>bean</code>，<code>@Component</code>类似于<code>@Controller、@Service、@Repository</code></p>
<p><code>dao</code>层用<code>@Repository</code><br><code>service</code>层用<code>@Service</code><br><code>controller</code>层用<code>@Controller</code><br>其它的用<code>@Component</code></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">;</span>

<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Repository<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Service<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>HandlerExceptionResolver<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ModelAndView<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>view<span class="token punctuation">.</span>json<span class="token punctuation">.</span>MappingJacksonJsonView<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionResolver</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerExceptionResolver</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ModelAndView <span class="token function">resolveException</span><span class="token punctuation">(</span>HttpServletRequest httpServletRequest<span class="token punctuation">,</span> HttpServletResponse httpServletResponse<span class="token punctuation">,</span> Object o<span class="token punctuation">,</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"{} Exception"</span><span class="token punctuation">,</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ModelAndView modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MappingJacksonJsonView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//当使用是jackson2.x的时候使用MappingJackson2JsonView，本项目使用的是1.9。</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span>ResponseCode<span class="token punctuation">.</span>ERROR<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"接口异常,详情请查看服务端日志的异常信息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h2 id="SpringMVC拦截器"><a href="#SpringMVC拦截器" class="headerlink" title="SpringMVC拦截器"></a>SpringMVC拦截器</h2><h3 id="springmvc配置拦截器"><a href="#springmvc配置拦截器" class="headerlink" title="springmvc配置拦截器"></a>springmvc配置拦截器</h3><p><code>&lt;mvc:mapping path=&quot;/manage/**&quot;/&gt;</code>代表请求经过<code>/manage</code>目录下的<strong>子目录</strong>下的<code>controller</code>也会被拦截</p>
<p><code>&lt;mvc:mapping path=&quot;/manage/*&quot;/&gt;</code>代表请求经过<code>/manage</code>目录下的<code>controller</code>会被拦截，而子目录下的<code>controller</code>不会被拦截</p>
<p><code>&lt;mvc:exclude-mapping path=&quot;/manage/user/login.do&quot;/&gt;</code>配置不拦截某些请求</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>interceptors</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- 定义在这里的，所有的都会拦截--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>interceptor</span><span class="token punctuation">></span></span>
        <span class="token comment" spellcheck="true">&lt;!--manage/a.do  /manage/*--></span>
        <span class="token comment" spellcheck="true">&lt;!--manage/b.do  /manage/*--></span>
        <span class="token comment" spellcheck="true">&lt;!--manage/product/save.do /manage/**--></span>
        <span class="token comment" spellcheck="true">&lt;!--manage/order/detail.do /manage/**--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>mapping</span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/manage/**<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token comment" spellcheck="true">&lt;!--&lt;mvc:exclude-mapping path="/manage/user/login.do"/>--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.mmall.controller.common.interceptor.AuthorityInterceptor<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mvc:</span>interceptor</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mvc:</span>interceptors</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="定义拦截器处理类"><a href="#定义拦截器处理类" class="headerlink" title="定义拦截器处理类"></a>定义拦截器处理类</h3><p><strong>preHandle</strong>请求到达<code>controll</code>之前会调用该方法</p>
<p><strong>postHandle</strong>请求到达<code>controller</code>处理后会调用该方法</p>
<p><strong>afterCompletion</strong>请求到达<code>controller</code>处理后返回<code>ModelAndView</code>后会调用该方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>common<span class="token punctuation">.</span>interceptor<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span>Maps<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">.</span>Const<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>common<span class="token punctuation">.</span>ServerResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>CookieUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>JsonUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>RedisShardedPoolUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>StringUtils<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>method<span class="token punctuation">.</span>HandlerMethod<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>HandlerInterceptor<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>ModelAndView<span class="token punctuation">;</span>

<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span>
<span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>PrintWriter<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Iterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorityInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"preHandle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//请求中Controller中的方法名</span>
        HandlerMethod handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span>HandlerMethod<span class="token punctuation">)</span>handler<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//解析HandlerMethod</span>

        String methodName <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String className <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//解析参数,具体的参数key以及value是什么，我们打印日志</span>
        StringBuffer requestParamBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map paramMap <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Iterator it <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            Map<span class="token punctuation">.</span>Entry entry <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String mapKey <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            String mapValue <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//request这个参数的map，里面的value返回的是一个String[]</span>
            Object obj <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> strs <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>obj<span class="token punctuation">;</span>
                mapValue <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>strs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            requestParamBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mapKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>mapValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"UserManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"权限拦截器拦截到请求,className:{},methodName:{}"</span><span class="token punctuation">,</span>className<span class="token punctuation">,</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//如果是拦截到登录请求，不打印参数，因为参数里面有密码，全部会打印到日志中，防止日志泄露</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"权限拦截器拦截到请求,className:{},methodName:{},param:{}"</span><span class="token punctuation">,</span>className<span class="token punctuation">,</span>methodName<span class="token punctuation">,</span>requestParamBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        User user <span class="token operator">=</span> null<span class="token punctuation">;</span>

        String loginToken <span class="token operator">=</span> CookieUtil<span class="token punctuation">.</span><span class="token function">readLoginToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>loginToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            String userJsonStr <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loginToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            user <span class="token operator">=</span> JsonUtil<span class="token punctuation">.</span><span class="token function">string2Obj</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">,</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Const<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>ROLE_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//返回false.即不会调用controller里的方法</span>
            response<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要添加reset，否则报异常 getWriter() has already been called for this response.</span>
            response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要设置编码，否则会乱码</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要设置返回值的类型，因为全部是json接口。</span>

            PrintWriter out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//上传由于富文本的控件要求，要特殊处理返回值，这里面区分是否登录以及是否有权限</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"ProductManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"richtextImgUpload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    Map resultMap <span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"请登录管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"拦截器拦截,用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"ProductManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"richtextImgUpload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    Map resultMap <span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"无权限操作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"拦截器拦截,用户无权限操作"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要关闭</span>

            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> ModelAndView modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"postHandle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">,</span> Exception ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"afterCompletion"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="登录死循环"><a href="#登录死循环" class="headerlink" title="登录死循环"></a>登录死循环</h3><p>描述：<code>springmvc</code>配置拦截器，如果登录请求也拦截的话，会导致一直登录不上，陷入死循环当中</p>
<p>解决：<br>方式一：可以在配置拦截器的时候过滤掉登录请求<code>&lt;mvc:exclude-mapping path=&quot;/manage/user/login.do&quot;/&gt;</code></p>
<p>方式二：拦截器处理类的<code>preHandle</code>方法会在到达<code>controller</code>调用该方法,因此可以在该方法中过滤掉登录请求不拦截</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"UserManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"权限拦截器拦截到请求,className:{},methodName:{}"</span><span class="token punctuation">,</span>className<span class="token punctuation">,</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//如果是拦截到登录请求，不打印参数，因为参数里面有密码，全部会打印到日志中，防止日志泄露</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="重置响应对象"><a href="#重置响应对象" class="headerlink" title="重置响应对象"></a>重置响应对象</h3><p>描述：拦截器处理类的三个方法都是返回布尔值，而<code>controller</code>都是返回<code>json</code>数据，请求如果被拦截到没有到达<code>controller</code>，那么在拦截器处理类的<code>preHandle</code>方法中必须重置响应对象</p>
<p>解决：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Const<span class="token punctuation">.</span>Role<span class="token punctuation">.</span>ROLE_ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//返回false.即不会调用controller里的方法</span>
    response<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要添加reset，否则报异常 getWriter() has already been called for this response.</span>
    response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要设置编码，否则会乱码</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要设置返回值的类型，因为全部是json接口。</span>

    PrintWriter out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//上传由于富文本的控件要求，要特殊处理返回值，这里面区分是否登录以及是否有权限</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"ProductManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"richtextImgUpload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            Map resultMap <span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"请登录管理员"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"拦截器拦截,用户未登录"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span><span class="token string">"ProductManageController"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span><span class="token string">"richtextImgUpload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            Map resultMap <span class="token operator">=</span> Maps<span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resultMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span><span class="token string">"无权限操作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JsonUtil<span class="token punctuation">.</span><span class="token function">obj2String</span><span class="token punctuation">(</span>ServerResponse<span class="token punctuation">.</span><span class="token function">createByErrorMessage</span><span class="token punctuation">(</span><span class="token string">"拦截器拦截,用户无权限操作"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//geelynote 这里要关闭</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre>
<h2 id="SpringMVC-RESTful改造"><a href="#SpringMVC-RESTful改造" class="headerlink" title="SpringMVC RESTful改造"></a>SpringMVC RESTful改造</h2><h3 id="编辑web-xml-1"><a href="#编辑web-xml-1" class="headerlink" title="编辑web.xml"></a>编辑<code>web.xml</code></h3><p>修改前</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.do<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<p>修改后</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>dispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="controller使用RESTful风格"><a href="#controller使用RESTful风格" class="headerlink" title="controller使用RESTful风格"></a>controller使用RESTful风格</h3><h4 id="根据id查询产品"><a href="#根据id查询产品" class="headerlink" title="根据id查询产品"></a>根据id查询产品</h4><p>修改前</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"detail.do"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>ProductDetailVo<span class="token operator">></span> <span class="token function">detail</span><span class="token punctuation">(</span>Integer productId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductDetail</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>修改后</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{productId}"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>ProductDetailVo<span class="token operator">></span> <span class="token function">detailRESTful</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> Integer productId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductDetail</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="搜索产品"><a href="#搜索产品" class="headerlink" title="搜索产品"></a>搜索产品</h4><h5 id="keyword、categoryId不为空"><a href="#keyword、categoryId不为空" class="headerlink" title="keyword、categoryId不为空"></a><code>keyword、categoryId</code>不为空</h5><p>修改前</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"list.do"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>String keyword<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"categoryId"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>Integer categoryId<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> pageNum<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span>categoryId<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>修改后</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//http://www.happymmall.com/product/手机/100012/1/10/price_asc</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{keyword}/{categoryId}/{pageNum}/{pageSize}/{orderBy}"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">listRESTful</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"keyword"</span><span class="token punctuation">)</span>String keyword<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"categoryId"</span><span class="token punctuation">)</span>Integer categoryId<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">)</span> Integer pageNum<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">,</span>
                                     <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageNum <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageSize <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderBy <span class="token operator">=</span> <span class="token string">"price_asc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span>categoryId<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="keyword、categoryId有一个为空"><a href="#keyword、categoryId有一个为空" class="headerlink" title="keyword、categoryId有一个为空"></a><code>keyword、categoryId</code>有一个为空</h5><h6 id="修改后版本一"><a href="#修改后版本一" class="headerlink" title="修改后版本一"></a>修改后版本一</h6><p><code>keyword</code>为空</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//    http://www.happymmall.com/product/100012/1/10/price_asc</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{categoryId}/{pageNum}/{pageSize}/{orderBy}"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">listRESTfulBadcase</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"categoryId"</span><span class="token punctuation">)</span>Integer categoryId<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">)</span> Integer pageNum<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageNum <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageSize <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderBy <span class="token operator">=</span> <span class="token string">"price_asc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>categoryId<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code>categoryId</code>为空</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/{keyword}/{pageNum}/{pageSize}/{orderBy}"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">listRESTfulBadcase</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"keyword"</span><span class="token punctuation">)</span>String keyword<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">)</span> Integer pageNum<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageNum <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageSize <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderBy <span class="token operator">=</span> <span class="token string">"price_asc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span>null<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>浏览器请求<a href="http://localhost:8088/mmall_war_exploded/product/100012/1/10/price_asc" target="_blank" rel="noopener">http://localhost:8088/mmall_war_exploded/product/100012/1/10/price_asc</a></p>
<p><img src="https://raw.githubusercontent.com/shenlibing/blogphoto/master/source/controller%E4%BD%BF%E7%94%A8RESTful%E9%A3%8E%E6%A0%BC.png" alt></p>
<p>发生了歧义，不知道要走哪一个方法，所以报错了</p>
<h6 id="修改后版本二"><a href="#修改后版本二" class="headerlink" title="修改后版本二"></a>修改后版本二</h6><p><code>categoryId</code>为空</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//http://www.happymmall.com/product/keyword/手机/1/10/price_asc</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/keyword/{keyword}/{pageNum}/{pageSize}/{orderBy}"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">listRESTful</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"keyword"</span><span class="token punctuation">)</span>String keyword<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">)</span> Integer pageNum<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageNum <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageSize <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderBy <span class="token operator">=</span> <span class="token string">"price_asc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span>null<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>keyword</code>为空</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//http://www.happymmall.com/product/category/100012/1/10/price_asc</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/category/{categoryId}/{pageNum}/{pageSize}/{orderBy}"</span><span class="token punctuation">,</span>method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> ServerResponse<span class="token operator">&lt;</span>PageInfo<span class="token operator">></span> <span class="token function">listRESTful</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"categoryId"</span><span class="token punctuation">)</span>Integer categoryId<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageNum"</span><span class="token punctuation">)</span> Integer pageNum<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"pageSize"</span><span class="token punctuation">)</span> Integer pageSize<span class="token punctuation">,</span>
                                                   <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"orderBy"</span><span class="token punctuation">)</span> String orderBy<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageNum <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageNum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pageSize <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        pageSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        orderBy <span class="token operator">=</span> <span class="token string">"price_asc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> iProductService<span class="token punctuation">.</span><span class="token function">getProductByKeywordCategory</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>categoryId<span class="token punctuation">,</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">,</span>orderBy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>浏览器访问<code>http://localhost:8088/mmall_war_exploded/product/keyword/手机/1/10/price_asc</code>和<code>http://localhost:8088/mmall_war_exploded/product/category/100002/1/10/price_asc</code></p>
<p>这样子就可以避免歧义</p>
<h2 id="Spring-Schedul定时任务"><a href="#Spring-Schedul定时任务" class="headerlink" title="Spring Schedul定时任务"></a>Spring Schedul定时任务</h2><h3 id="Cron生成器"><a href="#Cron生成器" class="headerlink" title="Cron生成器"></a>Cron生成器</h3><p><a href="http://cron.qqe2.com/" target="_blank" rel="noopener">在线Cron表达式生成器</a></p>
<h3 id="定时任务配置"><a href="#定时任务配置" class="headerlink" title="定时任务配置"></a>定时任务配置</h3><p>注解方式配置定时任务</p>
<h4 id="编辑spring配置文件"><a href="#编辑spring配置文件" class="headerlink" title="编辑spring配置文件"></a>编辑spring配置文件</h4><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span>
<span class="token attr-name"><span class="token namespace">xmlns:</span>task</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/task<span class="token punctuation">"</span></span>
<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/task
     http://www.springframework.org/schema/task/spring-task.xsd<span class="token punctuation">"</span></span>

<span class="token attr-name"><span class="token namespace">&lt;task:</span>annotation-driven</span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">></span></span>
</code></pre>
<h4 id="创建定时任务类"><a href="#创建定时任务类" class="headerlink" title="创建定时任务类"></a>创建定时任务类</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>task<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>service<span class="token punctuation">.</span>IOrderService<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>mmall<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PropertiesUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Scheduled<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * Created by geely
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloseOrderTask</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> IOrderService iOrderService<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//每隔5秒执行一次</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron<span class="token operator">=</span><span class="token string">"*/5 * * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrderTaskV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hour <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"close.order.task.time.hour"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        iOrderService.closeOrder(hour);</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="MySQL行锁、表锁"><a href="#MySQL行锁、表锁" class="headerlink" title="MySQL行锁、表锁"></a>MySQL行锁、表锁</h2><h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><h4 id="明确的主键"><a href="#明确的主键" class="headerlink" title="明确的主键"></a>明确的主键</h4><h5 id="明确指定主键id，并且有结果集-产生行锁"><a href="#明确指定主键id，并且有结果集-产生行锁" class="headerlink" title="明确指定主键id，并且有结果集,产生行锁"></a>明确指定主键<code>id</code>，并且有结果集,产生行锁</h5><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    mmall_product
<span class="token keyword">WHERE</span>
    id <span class="token operator">=</span> <span class="token string">'26'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="明确指定主键id，并且无结果集-无锁"><a href="#明确指定主键id，并且无结果集-无锁" class="headerlink" title="明确指定主键id，并且无结果集,无锁"></a>明确指定主键<code>id</code>，并且无结果集,无锁</h5><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    mmall_product
<span class="token keyword">WHERE</span>
    id <span class="token operator">=</span> <span class="token string">'66'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><h4 id="无明确的主键"><a href="#无明确的主键" class="headerlink" title="无明确的主键"></a>无明确的主键</h4><h5 id="无主键-产生表锁"><a href="#无主键-产生表锁" class="headerlink" title="无主键,产生表锁"></a>无主键,产生表锁</h5><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    mmall_product
<span class="token keyword">WHERE</span>
    NAME <span class="token operator">=</span> <span class="token string">'Apple iPhone 7 Plus (A1661) 128G 玫瑰金色 移动联通电信4G手机'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span></code></pre>
<h5 id="主键不明确产生表锁"><a href="#主键不明确产生表锁" class="headerlink" title="主键不明确产生表锁"></a>主键不明确产生表锁</h5><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    mmall_product
<span class="token keyword">WHERE</span>
    id <span class="token operator">&lt;></span> <span class="token string">'66'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    mmall_product
<span class="token keyword">WHERE</span>
    id <span class="token operator">LIKE</span> <span class="token string">'66'</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>关单:查询订单的时候，订单包含了子订单，根据子订单号查询产品</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectStockByProductId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>java.lang.Integer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
select
stock
from mmall_product
where id = #{id}
for update
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="xml转义"><a href="#xml转义" class="headerlink" title="xml转义"></a>xml转义</h3><p>用<code>&amp;lt![CDATA[]]&gt;&amp;gt</code>包裹住有转义的字符即可</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>selectOrderStatusByCreateTime<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
SELECT
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Base_Column_List<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
from mmall_order
where status = #{status}
&amp;lt![CDATA[
and create_time &lt;= #{date}
]]&amp;gt
order by create_time desc
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre>
<h2 id="原生分布式锁"><a href="#原生分布式锁" class="headerlink" title="原生分布式锁"></a>原生分布式锁</h2><p>Spring Schedule+Redis分布式锁构建分布式任务调度</p>
<h3 id="简单版"><a href="#简单版" class="headerlink" title="简单版"></a>简单版</h3><p>获取到锁，锁住时间5秒，如果此期间发生中断，会导致死锁</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//    @Scheduled(cron="0 */1 * * * ?")</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrderTaskV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> lockTimeout <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"lock.timeout"</span><span class="token punctuation">,</span><span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Long setnxResult <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>lockTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>setnxResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> setnxResult<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//如果返回值是1，代表设置成功，获取锁</span>
            <span class="token function">closeOrder</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"没有获得分布式锁:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span>String lockName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//有效期50秒，防止死锁</span>
        RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"获取{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hour <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"close.order.task.time.hour"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iOrderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"释放{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<h3 id="安全版"><a href="#安全版" class="headerlink" title="安全版"></a>安全版</h3><p>双重防死锁</p>
<p>未获取到锁，继续判断，判断时间戳，看是否可以重置并获取到锁</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron<span class="token operator">=</span><span class="token string">"0 */1 * * * ?"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrderTaskV3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> lockTimeout <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"lock.timeout"</span><span class="token punctuation">,</span><span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Long setnxResult <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">setnx</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>lockTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>setnxResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> setnxResult<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">closeOrder</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//未获取到锁，继续判断，判断时间戳，看是否可以重置并获取到锁</span>
            String lockValueStr <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>lockValueStr <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>lockValueStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                String getSetResult <span class="token operator">=</span> RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">getSet</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>lockTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//再次用当前时间戳getset。</span>
                <span class="token comment" spellcheck="true">//返回给定的key的旧值，->旧值判断，是否可以获取锁</span>
                <span class="token comment" spellcheck="true">//当key没有旧值时，即key不存在时，返回nil ->获取锁</span>
                <span class="token comment" spellcheck="true">//这里我们set了一个新的value值，获取旧的值。</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>getSetResult <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>getSetResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lockValueStr<span class="token punctuation">,</span>getSetResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//真正获取到锁</span>
                    <span class="token function">closeOrder</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"没有获取到分布式锁:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"没有获取到分布式锁:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"关闭订单定时任务结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span>String lockName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//有效期50秒，防止死锁</span>
        RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>lockName<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"获取{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hour <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"close.order.task.time.hour"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iOrderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
        RedisShardedPoolUtil<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"释放{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"==============================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<h2 id="Redisson分布式锁"><a href="#Redisson分布式锁" class="headerlink" title="Redisson分布式锁"></a>Redisson分布式锁</h2><h3 id="编辑pom-xml-2"><a href="#编辑pom-xml-2" class="headerlink" title="编辑pom.xml"></a>编辑pom.xml</h3><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-dataformat-avro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<h3 id="使用Redisson分布式锁"><a href="#使用Redisson分布式锁" class="headerlink" title="使用Redisson分布式锁"></a>使用Redisson分布式锁</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//    @Scheduled(cron="0 */1 * * * ?")</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrderTaskV4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        RLock lock <span class="token operator">=</span> redissonManager<span class="token punctuation">.</span><span class="token function">getRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> getLock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>getLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Redisson获取到分布式锁:{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> hour <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>PropertiesUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"close.order.task.time.hour"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//                iOrderService.closeOrder(hour);</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Redisson没有获取到分布式锁:{},ThreadName:{}"</span><span class="token punctuation">,</span>Const<span class="token punctuation">.</span>REDIS_LOCK<span class="token punctuation">.</span>CLOSE_ORDER_TASK_LOCK<span class="token punctuation">,</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Redisson分布式锁获取异常"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>getLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Redisson分布式锁释放锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>

            </div>
            <hr/>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Tomcat集群与Redis分布式》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2019/03/25/java-qi-ye-ji-dian-shang-xiang-mu-jia-gou-yan-jin-zhi-lu-tomcat-ji-qun-yu-redis-fen-bu-shi/" property="cc:attributionName"
               rel="cc:attributionURL">
                shenlibing
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '7b42617f95211d5847fc',
        clientSecret: 'e272c54840e0b98ae6fda880655f266b1923bc3f',
        repo: 'shenlibing.github.io',
        owner: 'shenlibing',
        admin: "shenlibing",
        id: '2019-03-25T09-58-28',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2019/04/03/springboot/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="SpringBoot">
                        
                        <span class="card-title">SpringBoot</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            springboot的入门使用、整合web、mybatis、服务端表单数据校验
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-04-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/框架/" class="post-category" target="_blank">
                                    框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/springboot/" target="_blank">
                        <span class="chip bg-color">springboot</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2019/03/20/nodejs/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="NodeJS">
                        
                        <span class="card-title">NodeJS</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            nodejs入门使用，增删改查，数据交互、文件上传、流操作
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-03-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/前端/" class="post-category" target="_blank">
                                    前端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/NodeJS/" target="_blank">
                        <span class="chip bg-color">NodeJS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1,h2, h3, h4,h5,h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1,h2, h3, h4,h5,h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站由&copy;<a href="https://github.com/shenlibing" target="_blank">shenlibing</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="#" target="_blank">沈先森</a>主题搭建.
            <!-- <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建. -->

              <!-- 友情链接:<a href="http://www.ityouknow.com/" target="_blank">纯洁的微笑</a>  -->
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->



    <script src="/libs/others/clicklove.js"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>


</body>
</html>